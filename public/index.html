<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini-Powered Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind configuration: Inter font ko default rakha gaya hai
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <!-- FontAwesome is not strictly necessary but kept for potential icons -->
    <!-- <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script> -->
    <style>
        /* Custom CSS */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .chat-container {
            max-width: 700px;
            margin: 20px auto;
            min-height: 85vh; /* Thoda zyada height responsive look ke liye */
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); /* Thoda gehra shadow */
            overflow: hidden;
            background-color: white;
        }
        .message-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex; /* Flexbox for dynamic message positioning */
            flex-direction: column;
        }
        /* Mobile-first adjustments */
        @media (max-width: 640px) {
            .chat-container {
                margin: 0;
                min-height: 100vh;
                border-radius: 0;
            }
        }
        .message {
            max-width: 90%; /* Mobile ke liye zyada width */
            padding: 10px 15px;
            border-radius: 16px;
            margin-bottom: 12px;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .message-incoming {
            background-color: #e5e7eb; /* Halka grey */
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .message-outgoing {
            background-color: #4338CA; /* Deep Indigo 700 */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .loading-overlay {
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.95);
        }
    </style>
</head>
<body class="p-4 md:p-0">

    <div id="loadingOverlay" class="fixed inset-0 loading-overlay hidden">
        <div class="flex flex-col items-center justify-center h-full">
            <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600"></div>
            <p id="loading-text" class="mt-4 text-lg font-semibold text-indigo-600">Authenticating...</p>
        </div>
    </div>

    <div class="chat-container">
        <header class="p-4 border-b border-gray-200 bg-indigo-50 flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold text-indigo-700">Gemini Chat</h1>
            <p id="authStatus" class="text-xs text-gray-500 mt-1">Authenticating...</p>
        </header>

        <div id="messages" class="message-area">
            <p id="initial-msg" class="text-center text-gray-400 my-4">Waiting for connection...</p>
        </div>
        
        <!-- AI Status Box to show Summarize/Tone Check results -->
        <div id="ai-status-box" class="p-3 bg-yellow-50 border-t border-yellow-200 hidden transition-all duration-300">
            <p class="font-semibold text-yellow-800">AI Result:</p>
            <p id="ai-result-content" class="text-sm text-gray-700 mt-1"></p>
        </div>

        <div class="p-4 border-t border-gray-200 bg-white flex items-center space-x-2">
            <input type="text" id="messageInput" placeholder="Type a message..." 
                   class="flex-1 p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150" disabled>
            <button id="sendButton" class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-xl font-semibold transition duration-150 shadow-lg disabled:bg-indigo-400" disabled>
                Send
            </button>
        </div>
    </div>

    <script type="module">
        // --- Firebase Modules Import (Updated to 12.5.0) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // --- Configuration & Global State ---
        let db, auth;
        let userId = null;
        let isAuthReady = false;
        
        // Canvas environment variables ko safely access karein
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // User dwara di gayi Firebase Configuration ko seedhe istemaal karein
        const firebaseConfig = {
            apiKey: "AIzaSyBmImrvVVCJ5E1yAZAI4NXSweEg__hqF94",
            authDomain: "private-chat-14deb.firebaseapp.com",
            projectId: "private-chat-14deb",
            storageBucket: "private-chat-14deb.firebasestorage.app",
            messagingSenderId: "255060970461",
            appId: "1:255060970461:web:e6dd31ce5952334ae64434",
            measurementId: "G-QWDK17SMY9"
        };


        // Gemini API configuration
        const apiKey = ""; 
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

        // UI Elements
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const authStatusElement = document.getElementById('authStatus');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loading-text');
        const aiStatusBox = document.getElementById('ai-status-box');
        const aiResultContent = document.getElementById('ai-result-content');

        // --- Utility Functions ---

        // Function: Loading state ko manage karna
        function setLoading(isLoading, text = "Processing...") {
            loadingText.textContent = isLoading ? text : "Authenticating...";
            loadingOverlay.classList.toggle('hidden', !isLoading);
            // Input aur button ko enable sirf tab karein jab auth ready ho aur loading na ho
            const enableInput = isAuthReady && !isLoading;
            messageInput.disabled = !enableInput;
            sendButton.disabled = !enableInput;
        }
        
        // Function: AI Status box ko hide karna
        function hideAIStatus() {
            aiStatusBox.classList.add('hidden');
        }

        // --- Core Logic Functions ---

        // Function: Exponential Backoff ke saath Gemini API ko call karna
        async function callGemini(userPrompt, systemPrompt, retries = 3) {
            setLoading(true, "Gemini is thinking...");
            hideAIStatus();

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: [{ "google_search": {} }], // Google Search enable karna
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < retries - 1) {
                        // Too Many Requests (Rate Limit), wait and retry
                        const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    const modelText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I could not generate a response.";
                    
                    return modelText;

                } catch (error) {
                    console.error(`Gemini API call error (Attempt ${i + 1}):`, error);
                    if (i === retries - 1) {
                        return `Error: Failed to connect to AI after multiple attempts. (${error.message.substring(0, 50)}...)`;
                    }
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                } finally {
                     if (i === retries - 1) {
                        // Last attempt ke baad loading stop karna
                        setLoading(false, "Ready.");
                    }
                }
            }
        }

        // Function: Chat UI mein message display karna
        function displayMessage(message) {
            const messageElement = document.createElement('div');
            // Message role ke hisaab se styling adjust karna
            messageElement.classList.add('flex', 'flex-col', message.uid === userId ? 'items-end' : 'items-start');
            
            // Timestamp format karna
            const timestampDate = message.timestamp?.toDate ? message.timestamp.toDate() : new Date();
            const timestampText = timestampDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            // User ka display naam
            const userDisplayName = message.displayName || (message.uid === userId ? 'You' : `Guest-${message.uid.substring(0, 4)}`);

            messageElement.innerHTML = `
                <div class="message ${message.uid === userId ? 'message-outgoing' : 'message-incoming'} relative">
                    <p class="text-xs font-semibold mb-1 opacity-80 ${message.uid === userId ? 'text-indigo-200' : 'text-gray-600'}">${userDisplayName}</p>
                    <p class="${message.uid === userId ? 'text-white' : 'text-gray-800'}">${message.text}</p>
                    <div class="text-xs mt-1 text-right ${message.uid === userId ? 'text-indigo-200' : 'text-gray-500'}">${timestampText}</div>
                    
                    ${message.uid === userId ? `
                        <div class="flex mt-2 space-x-2 justify-end pt-1 border-t border-indigo-500/30">
                            <button data-text="${message.text.replace(/"/g, '&quot;')}" class="ai-button text-xs font-medium text-gray-800 hover:text-indigo-900 bg-white hover:bg-gray-100 rounded-lg px-2 py-1 shadow-md transition duration-150" data-feature="Summarize">
                                <span class="text-indigo-600 font-bold">AI:</span> Summarize
                            </button>
                            <button data-text="${message.text.replace(/"/g, '&quot;')}" class="ai-button text-xs font-medium text-gray-800 hover:text-indigo-900 bg-white hover:bg-gray-100 rounded-lg px-2 py-1 shadow-md transition duration-150" data-feature="Tone Check">
                                <span class="text-indigo-600 font-bold">AI:</span> Tone Check
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight; 
        }

        // Function: AI Feature Handler (Summarize/Tone Check)
        async function handleAIFeature(messageText, feature) {
            const systemPrompt = feature === 'Summarize' 
                ? "You are a concise summarization expert. Summarize the user's message in one short, clear sentence. Do not add any conversational text."
                : "You are an expert on tone. Analyze the following message and state its overall tone (e.g., serious, playful, urgent) and provide one word describing its sentiment (positive, negative, neutral) in a short, single phrase. Do not add any conversational text.";
            
            const fullPrompt = `Message to analyze: "${messageText}"`;
            
            // Status box update
            aiStatusBox.classList.remove('hidden', 'bg-red-50', 'border-red-200', 'bg-green-50', 'border-green-200');
            aiStatusBox.classList.add('bg-blue-50', 'border-blue-200');
            aiResultContent.innerHTML = `<span class="text-blue-700 font-semibold">${feature}ing... Please wait.</span>`;
            
            const resultText = await callGemini(fullPrompt, systemPrompt);

            // Final status box update
            aiStatusBox.classList.remove('bg-blue-50', 'border-blue-200');
            if (resultText.startsWith("Error:")) {
                 aiStatusBox.classList.add('bg-red-50', 'border-red-200');
            } else {
                 aiStatusBox.classList.add('bg-green-50', 'border-green-200');
            }
            
            aiStatusBox.classList.remove('hidden');
            aiResultContent.innerHTML = `**${feature}**: ${resultText}`;
        }

        // Function: Firestore se real-time messages ko sunna
        function setupChatListener() {
            if (!db || !userId) return;

            // Public chat data path: /artifacts/{appId}/public/data/messages
            const chatRef = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
            // orderBy('timestamp', 'asc') is used here, but for production, Firestore indexes need to be created.
            const q = query(chatRef, orderBy('timestamp', 'asc'));

            // Real-time listener
            onSnapshot(q, (snapshot) => {
                messagesContainer.innerHTML = ''; 
                document.getElementById('initial-msg').style.display = 'none';

                snapshot.forEach(doc => {
                    const message = doc.data();
                    displayMessage(message);
                });

                // AI Buttons ke liye event listeners attach karna
                document.querySelectorAll('.ai-button').forEach(button => {
                    button.onclick = (e) => {
                        e.stopPropagation(); 
                        const text = button.getAttribute('data-text');
                        const feature = button.getAttribute('data-feature');
                        handleAIFeature(text, feature);
                    };
                });

                if (snapshot.empty) {
                    messagesContainer.innerHTML = '<p class="text-center text-gray-500 my-4">Start the conversation!</p>';
                }
            }, (error) => {
                console.error("Error listening to messages: ", error);
                authStatusElement.textContent = `Chat Error: ${error.message.substring(0, 50)}...`;
            });
        }

        // Function: Message ko Firestore mein save karna
        async function saveMessage(text) {
            if (!db || !userId) {
                console.error("Database or User ID not available.");
                throw new Error("Cannot send message: Authentication or database connection is not ready.");
            }
            const chatRef = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
            await addDoc(chatRef, {
                text: text,
                uid: userId, // User ID store karna zaroori hai
                timestamp: serverTimestamp()
            });
        }

        // --- Initialization and Event Handlers ---

        async function initializeFirebase() {
            // Check karein ki configuration empty hai ya nahi (Though hardcoded now, good practice)
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                 authStatusElement.textContent = "Error: Firebase configuration missing or invalid!";
                 setLoading(false);
                 console.error("Initialization Failed: Firebase config is empty or lacks apiKey.");
                 return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Authentication state change listener setup karna
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User signed in hai
                        userId = user.uid;
                        authStatusElement.textContent = `User ID: ${userId.substring(0, 10)}... | App ID: ${appId.substring(0, 4)}...`;
                        isAuthReady = true;
                        // Loading stop karke input enable karna
                        setLoading(false, "Ready."); 
                        setupChatListener(); 
                    } else {
                        // User signed out hai, sign-in process shuru karein
                         authStatusElement.textContent = "Authenticating...";
                         isAuthReady = false;
                         setLoading(true, "Signing in...");
                        
                        // Custom Token ya Anonymous sign-in
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (signError) {
                            authStatusElement.textContent = `Auth Failed: ${signError.message.substring(0, 50)}...`;
                            setLoading(false);
                            console.error("Sign-in failed:", signError);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                authStatusElement.textContent = `Initialization Error: ${error.message}`;
                setLoading(false);
            }
        }

        async function handleSend() {
            const userText = messageInput.value.trim();
            // Agar input khali ho ya auth ready na ho to return kar dein
            if (userText === "" || !isAuthReady) return;

            messageInput.value = '';
            
            // UI elements ko disable karna for better user experience
            sendButton.disabled = true; 
            messageInput.disabled = true;

            try {
                // Message save karna Firestore mein
                await saveMessage(userText);
            } catch (error) {
                console.error("Send message error:", error);
                // Auth status mein error dikhana
                authStatusElement.textContent = `Error sending: ${error.message.substring(0, 40)}...`;
            } finally {
                // Button aur Input ko dobara enable kar dein
                sendButton.disabled = false;
                messageInput.disabled = false;
            }
        }

        // Event Listeners ko Attach karein
        sendButton.addEventListener('click', handleSend);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                handleSend();
            }
        });

        // App ko shuru karein jab window load ho jaaye
        window.onload = () => {
            // Initial loading state set karein
            setLoading(true, "Connecting to Firebase...");
            initializeFirebase();
        };

    </script>
</body>
</html>